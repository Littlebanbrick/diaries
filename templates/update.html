<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>ä¸Šä¼ æ–°æ—¥è®° Â· Diaries</title>
  <!-- è‹±æ–‡å­—ä½“ Montserrat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- ä¸­æ–‡å­—ä½“ éœé¹œæ–‡æ¥· -->
  <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai&display=swap" rel="stylesheet">
  <!-- å“ç‰Œicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%23FFB6C1'/%3E%3Cstop offset='100%25' stop-color='%23B4E6D9'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='46' fill='url(%23grad)' /%3E%3Cpath d='M34 33 L66 33 L66 67 L34 67 Z' fill='none' stroke='%23FFFFFF' stroke-width='5' stroke-linejoin='round'/%3E%3Ccircle cx='50' cy='42' r='6' fill='%23FFFFFF' /%3E%3Cline x1='42' y1='54' x2='58' y2='54' stroke='%23FFFFFF' stroke-width='4' stroke-linecap='round'/%3E%3Cline x1='42' y1='62' x2='58' y2='62' stroke='%23FFFFFF' stroke-width='4' stroke-linecap='round'/%3E%3Cline x1='42' y1='70' x2='52' y2='70' stroke='%23FFFFFF' stroke-width='4' stroke-linecap='round'/%3E%3C/svg%3E">
  <style>
    /* ---------- å…¨å±€é‡ç½® & æ³¡æ³¡èƒŒæ™¯ ---------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #f5f7fa;
      background-image: 
        radial-gradient(circle at 18% 25%, rgba(220, 219, 219, 0.3) 40px, transparent 40px),
        radial-gradient(circle at 75% 12%, rgba(220, 219, 219, 0.3) 70px, transparent 70px),
        radial-gradient(circle at 45% 78%, rgba(220, 219, 219, 0.3) 90px, transparent 90px),
        radial-gradient(circle at 88% 60%, rgba(220, 219, 219, 0.3) 55px, transparent 55px),
        radial-gradient(circle at 8% 82%, rgba(220, 219, 219, 0.3) 65px, transparent 65px),
        radial-gradient(circle at 35% 35%, rgba(220, 219, 219, 0.3) 100px, transparent 100px),
        radial-gradient(circle at 62% 48%, rgba(220, 219, 219, 0.3) 48px, transparent 48px),
        radial-gradient(circle at 92% 88%, rgba(220, 219, 219, 0.3) 85px, transparent 85px),
        radial-gradient(circle at 52% 15%, rgba(220, 219, 219, 0.3) 60px, transparent 60px);
      background-size: 200% 200%, 180% 180%, 220% 220%, 190% 190%, 210% 210%, 230% 230%, 200% 200%, 240% 240%, 170% 170%;
      background-position: 0 0;
      font-family: 'LXGW WenKai', 'Noto Serif SC', 'Georgia', 'Times New Roman', serif;
      color: #1e2a2f;
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 0;
      letter-spacing: 0.2px;
    }

    .app-wrapper {
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* ---------- é¡¶éƒ¨å¯¼èˆªæ  ---------- */
    .nav-bar {
      width: 100%;
      max-width: 1200px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2rem;
      margin: 0 auto;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.65rem 1.6rem;
      background: linear-gradient(115deg, #ffe8f0, #ffdee8);
      border: 1.8px solid rgba(255, 182, 193, 0.5);
      border-radius: 60px;
      font-size: 1.1rem;
      font-weight: 500;
      color: #3b2c32;
      text-decoration: none;
      backdrop-filter: blur(4px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.02);
      transition: all 0.2s ease;
      font-family: 'Montserrat', 'LXGW WenKai', sans-serif;
      white-space: nowrap;
    }

    .back-btn:hover {
      background: linear-gradient(115deg, #ffdae5, #ffccd9);
      border-color: #faa0b6;
      box-shadow: 0 16px 24px rgba(250, 160, 182, 0.12);
      transform: translateY(-2px);
    }

    .back-btn:active {
      transform: translateY(2px);
    }

    .submit-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.65rem 1.8rem;
      background: linear-gradient(115deg, #e1f2ef, #d4ece7);
      border: 1.8px solid rgba(104, 184, 170, 0.4);
      border-radius: 60px;
      font-size: 1.1rem;
      font-weight: 500;
      color: #1e403e;
      text-decoration: none;
      backdrop-filter: blur(4px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.02);
      transition: all 0.2s ease;
      font-family: 'Montserrat', 'LXGW WenKai', sans-serif;
      white-space: nowrap;
      border: none;
      cursor: pointer;
    }

    .submit-btn:hover {
      background: linear-gradient(115deg, #cde9e2, #bde3db);
      border-color: #68b8aa;
      box-shadow: 0 16px 24px rgba(104, 184, 170, 0.12);
      transform: translateY(-2px);
    }

    .submit-btn:active {
      transform: translateY(2px);
    }

    /* ---------- ä¸»ç¼–è¾‘åŒº ---------- */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 1rem 1.5rem 3rem;
    }

    .editor-card {
      width: 100%;
      max-width: 780px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 36px;
      padding: 2.8rem 2.8rem;
      box-shadow: 0 20px 36px rgba(0, 0, 0, 0.02), 0 4px 12px rgba(0, 0, 0, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .form-group {
      margin-bottom: 2rem;
    }

    .form-label {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 1.1rem;
      font-weight: 480;
      color: #2a4a4a;
      margin-bottom: 0.6rem;
      font-family: 'LXGW WenKai', 'Noto Serif SC', serif;
    }

    .input-field, .textarea-field {
      width: 100%;
      padding: 0.9rem 1.4rem;
      font-size: 1rem;
      font-family: 'LXGW WenKai', 'Noto Serif SC', 'Montserrat', sans-serif;
      border: 1.5px solid rgba(200, 200, 200, 0.3);
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(4px);
      transition: all 0.2s ease;
      color: #1e2a2f;
      outline: none;
      resize: vertical;
    }

    .input-field:focus, .textarea-field:focus {
      border-color: #b4e6d9;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 4px rgba(180, 230, 217, 0.2);
    }

    .textarea-field {
      min-height: 160px;
      line-height: 1.6;
    }

    /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ */
    .image-upload-area {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .btn-green {
      background: linear-gradient(115deg, #e1f2ef, #d4ece7);
      border: 1.8px solid rgba(104, 184, 170, 0.4);
      color: #1e403e;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.7rem 2rem;
      border-radius: 60px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      backdrop-filter: blur(4px);
      transition: all 0.2s ease;
      border: none;
      font-family: 'Montserrat', 'LXGW WenKai', sans-serif;
      width: fit-content;
    }

    .btn-green:hover {
      background: linear-gradient(115deg, #cde9e2, #bde3db);
      border-color: #68b8aa;
      box-shadow: 0 16px 24px rgba(104, 184, 170, 0.12);
      transform: translateY(-2px);
    }

    .image-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      margin-top: 0.5rem;
      min-height: 100px;
    }

    .image-thumb {
      width: 90px;
      height: 90px;
      border-radius: 16px;
      background-color: #d9e3e0;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.02);
      transition: transform 0.1s ease;
      position: relative;
      overflow: hidden;
    }

    .image-thumb:hover {
      transform: scale(1.05);
    }

    .remove-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 18px;
      height: 18px;
      background-color: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      color: #b34a4a;
      font-weight: bold;
    }

    .upload-hint {
      font-size: 0.9rem;
      color: #5b7270;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-family: 'Montserrat', 'LXGW WenKai', sans-serif;
    }

    /* é¡µè„š */
    .footer {
      flex-shrink: 0;
      width: 100%;
      text-align: center;
      padding: 2rem 0.8rem 1.5rem;
      font-size: 0.95rem;
      color: #6c7a7e;
      font-family: 'Montserrat', 'LXGW WenKai', 'Noto Serif SC', sans-serif;
      font-weight: 400;
      letter-spacing: 0.5px;
      background: none;
      border: none;
      border-radius: 0;
      backdrop-filter: none;
      box-shadow: none;
    }

    /* å“åº”å¼ */
    @media (max-width: 600px) {
      .nav-bar {
        padding: 1.2rem 1.5rem;
      }
      .back-btn, .submit-btn {
        padding: 0.55rem 1.2rem;
        font-size: 1rem;
      }
      .editor-card {
        padding: 1.8rem 1.5rem;
        border-radius: 28px;
      }
      .image-thumb {
        width: 75px;
        height: 75px;
      }
    }

    @media (max-width: 480px) {
      .nav-bar {
        padding: 1rem 1.2rem;
      }
      .editor-card {
        padding: 1.5rem 1.2rem;
      }
      .image-thumb {
        width: 65px;
        height: 65px;
      }
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼šè¿”å›é¦–é¡µ + æäº¤æŒ‰é’®ï¼ˆè§¦å‘è¡¨å•æäº¤ï¼‰ -->
    <div class="nav-bar">
      <a href="/" class="back-btn">
        <span style="font-size:1.2rem;">â†</span> è¿”å›é¦–é¡µ
      </a>
      <button type="submit" form="diaryForm" class="submit-btn">
        æäº¤æ—¥è®° <span style="font-size:1.2rem;">â†’</span>
      </button>
    </div>

    <!-- ä¸­å¤®ç¼–è¾‘å¡ç‰‡ -->
    <div class="main-content">
      <div class="editor-card">
        <!-- è¡¨å•å¿…é¡»åŒ…å« enctype ä»¥æ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼Œid ä¾›æŒ‰é’®å…³è” -->
        <form id="diaryForm" method="post" action="/update/submit/" enctype="multipart/form-data">
          <!-- æ ‡é¢˜ -->
          <div class="form-group">
            <div class="form-label">
              <span>ğŸ“Œ</span> æ ‡é¢˜
            </div>
            <input type="text" name="title" class="input-field" placeholder="ç»™ä»Šå¤©çš„æ—¥è®°èµ·ä¸ªåå­—" required>
          </div>

          <!-- å‰¯æ ‡é¢˜ -->
          <div class="form-group">
            <div class="form-label">
              <span>ğŸ”–</span> å‰¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
            </div>
            <input type="text" name="subtitle" class="input-field" placeholder="ä¸€å¥è¯æ¦‚æ‹¬æ­¤åˆ»å¿ƒæƒ…">
          </div>

          <!-- æ­£æ–‡ -->
          <div class="form-group">
            <div class="form-label">
              <span>ğŸ“„</span> æ­£æ–‡
            </div>
            <textarea name="content" class="textarea-field" placeholder="å†™ä¸‹ä½ çš„æ•…äº‹â€¦â€¦" required></textarea>
          </div>

          <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
          <div class="form-group">
            <div class="form-label">
              <span>ğŸ–¼ï¸</span> å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰ <span style="font-size:0.9rem; color:#5e7a78;">(æœ€å¤š9å¼ )</span>
            </div>
            <div class="image-upload-area">
              <!-- è‡ªå®šä¹‰æ·»åŠ å›¾ç‰‡æŒ‰é’®ï¼ˆè§¦å‘éšè— file inputï¼‰ -->
              <button type="button" id="addImagesBtn" class="btn-green">
                <span>ğŸ“·</span> æ·»åŠ å›¾ç‰‡
              </button>
              <!-- éšè—çš„å¤šé€‰æ–‡ä»¶è¾“å…¥ -->
              <input type="file" id="imageInput" name="images" multiple accept="image/*" style="display: none;">
              <!-- é¢„è§ˆç½‘æ ¼ -->
              <div class="image-grid" id="imagePreviewGrid"></div>
              <!-- æç¤º -->
              <div class="upload-hint">
                <span>ğŸ“</span> æ”¯æŒ jpg, png, heic Â· å·²é€‰ <span id="imageCount">0</span>/9
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="footer">
      Â© Copyright Johnny Wang
    </footer>
  </div>

  <!-- JavaScript å¤„ç†å›¾ç‰‡é¢„è§ˆä¸è®¡æ•° -->
  <script>
    (function() {
      const addImagesBtn = document.getElementById('addImagesBtn');
      const imageInput = document.getElementById('imageInput');
      const previewGrid = document.getElementById('imagePreviewGrid');
      const imageCountSpan = document.getElementById('imageCount');
      const MAX_IMAGES = 9;
      let selectedFiles = [];  // å­˜å‚¨å½“å‰é€‰æ‹©çš„æ–‡ä»¶å¯¹è±¡

      // ç‚¹å‡»æŒ‰é’®è§¦å‘æ–‡ä»¶é€‰æ‹©
      addImagesBtn.addEventListener('click', () => {
        imageInput.click();
      });

      // ç›‘å¬æ–‡ä»¶é€‰æ‹©å˜åŒ–
      imageInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (selectedFiles.length + files.length > MAX_IMAGES) {
          alert(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_IMAGES} å¼ å›¾ç‰‡ï¼Œå½“å‰å·²é€‰ ${selectedFiles.length} å¼ ï¼Œæ–°å¢ ${files.length} å¼ å°†è¶…å‡ºé™åˆ¶ã€‚`);
          return;
        }

        // å°†æ–°æ–‡ä»¶åŠ å…¥æ•°ç»„
        selectedFiles = selectedFiles.concat(files);

        // é‡æ–°æ¸²æŸ“é¢„è§ˆ
        renderPreviews();

        // æ¸…ç©º input ä»¥ä¾¿å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        imageInput.value = '';
      });

      // æ¸²æŸ“é¢„è§ˆç½‘æ ¼
      function renderPreviews() {
        previewGrid.innerHTML = '';
        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'image-thumb';
            thumbDiv.style.backgroundImage = `url('${e.target.result}')`;

            // åˆ é™¤æŒ‰é’®
            const removeBtn = document.createElement('span');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = 'âœ•';
            removeBtn.onclick = (ev) => {
              ev.stopPropagation();
              // ä» selectedFiles ä¸­ç§»é™¤è¯¥æ–‡ä»¶
              selectedFiles.splice(index, 1);
              renderPreviews();  // é‡æ–°æ¸²æŸ“
            };

            thumbDiv.appendChild(removeBtn);
            previewGrid.appendChild(thumbDiv);
          };
          reader.readAsDataURL(file);
        });

        // æ›´æ–°è®¡æ•°
        imageCountSpan.textContent = selectedFiles.length;

        // æ ¹æ®æ˜¯å¦å·²æ»¡è°ƒæ•´æ·»åŠ æŒ‰é’®çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
        if (selectedFiles.length >= MAX_IMAGES) {
          addImagesBtn.disabled = true;
          addImagesBtn.style.opacity = '0.5';
          addImagesBtn.style.cursor = 'not-allowed';
        } else {
          addImagesBtn.disabled = false;
          addImagesBtn.style.opacity = '1';
          addImagesBtn.style.cursor = 'pointer';
        }

        // ä¸ºäº†é…åˆè¡¨å•æäº¤ï¼Œéœ€è¦å°†é€‰ä¸­çš„æ–‡ä»¶å…³è”åˆ° inputï¼Ÿé»˜è®¤ä¸ä¼šï¼Œå› ä¸º input çš„ files æ˜¯åªè¯»çš„ã€‚
        // è§£å†³æ–¹æ¡ˆï¼šä¸ä½¿ç”¨éšè— input æäº¤ï¼Œè€Œæ˜¯ç”¨ FormData æ‰‹åŠ¨æ„é€ ã€‚ä½†ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æäº¤æ—¶åŠ¨æ€æ„å»º FormDataã€‚
        // ç„¶è€Œï¼Œå½“å‰è®¾è®¡æ˜¯ç”¨æˆ·ç‚¹å‡»â€œæäº¤æ—¥è®°â€æŒ‰é’®è§¦å‘è¡¨å•æäº¤ï¼Œè€Œè¡¨å•å†…çš„ file input å¹¶æ²¡æœ‰åŒ…å« selectedFilesï¼ˆå› ä¸º input è¢«æˆ‘ä»¬æ¸…ç©ºäº†ï¼‰ã€‚
        // å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨è¡¨å•æäº¤æ—¶ï¼Œç”¨ JavaScript æ‹¦æˆªå¹¶æ„é€ æ–°çš„ FormDataï¼Œå°† selectedFiles å…¨éƒ¨æ·»åŠ è¿›å»ã€‚
        // ä¸‹é¢æ·»åŠ è¡¨å•æäº¤äº‹ä»¶å¤„ç†ã€‚
      }

      // å¤„ç†è¡¨å•æäº¤ï¼šç”¨ FormData é‡æ–°ç»„è£…ï¼ŒåŒ…å«æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
      const form = document.getElementById('diaryForm');
      form.addEventListener('submit', (e) => {
        e.preventDefault();  // é˜»æ­¢é»˜è®¤æäº¤

        const formData = new FormData(form);
        // ç§»é™¤åŸæœ‰çš„ files æ¡ç›®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œinput å·²è¢«æ¸…ç©ºï¼Œä½†ä¸ºäº†å®‰å…¨ï¼‰
        formData.delete('images');
        // æ·»åŠ æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
        selectedFiles.forEach((file) => {
          formData.append('images', file);
        });

        // ä½¿ç”¨ fetch æäº¤
        fetch(form.action, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.redirected) {
            // å¦‚æœæœåŠ¡å™¨è¿”å›é‡å®šå‘ï¼ˆæ¯”å¦‚æˆåŠŸé¡µï¼‰ï¼Œè·³è½¬
            window.location.href = response.url;
          } else {
            // å¦‚æœè¿”å›é”™è¯¯é¡µé¢ï¼ˆæ¯”å¦‚å¤±è´¥ï¼‰ï¼Œä¹Ÿè·³è½¬ï¼ˆå› ä¸ºæœåŠ¡å™¨å¯èƒ½è¿”å›å¤±è´¥é¡µï¼‰
            window.location.href = response.url;
          }
        })
        .catch(error => {
          console.error('æäº¤å¤±è´¥', error);
          alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
      });

      // åˆå§‹åŒ–æ¸²æŸ“ï¼ˆæ— æ–‡ä»¶ï¼‰
      renderPreviews();
    })();
  </script>
</body>
</html>